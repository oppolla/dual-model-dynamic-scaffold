<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOVL System Control Panel</title>
    <style>
    /* Your existing CSS remains unchanged */
    body {
        font-family: 'Verdana', sans-serif;
        margin: 0;
        padding: 20px;
        background: #1d1a13;
        color: #e0e0e0;
    }
    .container {
        max-width: 1400px;
        margin: 0 auto;
        background: #252218;
        padding: 20px;
        border-radius: 4px;
        border: 1px solid #333;
    }
    .section {
        margin-bottom: 20px;
        padding: 15px;
        background: #1d1a13;
        border: 1px solid #383838;
        border-radius: 4px;
    }
    .section-title {
        font-size: 0.9em;
        margin-bottom: 12px;
        color: #629470;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: bold;
        border-bottom: 1px solid #383838;
        padding-bottom: 6px;
    }
    .control-group {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 12px;
        margin-bottom: 12px;
    }
    .control-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
    }
    label {
        color: #d8dff4;
        font-size: 0.75em;
        text-align: center;
    }
    select {
        padding: 5px;
        border: 1px solid #444;
        border-radius: 3px;
        background: #1e1e1e;
        color: #95999f;
        width: 100%;
        font-size: 0.8em;
        appearance: none;
        background-image: url('data:image/svg+xml;utf8,<svg fill="%23aaa" height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M4 6l4 4 4-4z"/></svg>');
        background-repeat: no-repeat;
        background-position: right 5px center;
    }
    input[type="range"] {
        -webkit-appearance: none;
        width: 100%;
        height: 6px;
        background: #25373b;
        border-radius: 3px;
        outline: none;
    }
    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 14px;
        height: 14px;
        background: #6dac89;
        border-radius: 50%;
        cursor: pointer;
        border: 1px solid #333;
    }
    .value-display {
        font-size: 0.7em;
        color: #7db98d;
        font-family: 'Segoe UI Variable', monospace;
    }
    input[type="checkbox"] {
        appearance: none;
        width: 36px;
        height: 18px;
        background: #25373b;
        border-radius: 9px;
        position: relative;
        cursor: pointer;
        border: 1px solid #444;
    }
    input[type="checkbox"]:checked {
        background: #25373b;
    }
    input[type="checkbox"]::before {
        content: '';
        position: absolute;
        width: 14px;
        height: 14px;
        background: #6dac89;
        border-radius: 50%;
        top: 1px;
        left: 1px;
        transition: transform 0.2s;
    }
    input[type="checkbox"]:checked::before {
        transform: translateX(18px);
    }
    button {
        background: #6dac89;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 3px;
        cursor: pointer;
        text-transform: uppercase;
        font-size: 0.8em;
        font-weight: bold;
        letter-spacing: 0.5px;
    }
    button:hover {
        background: #4a785f;
    }
    .response {
        margin-top: 15px;
        padding: 12px;
        background: #1e1e1e;
        border: 1px solid #383838;
        border-radius: 3px;
        color: #00a2ff;
        font-family: 'Segoe UI Variable', monospace;
        font-size: 0.85em;
        line-height: 1.4;
    }
    h1 {
        color: #629470;
        text-align: center;
        text-transform: uppercase;
        font-size: 1.8em;
        letter-spacing: 1px;
        margin-bottom: 25px;
        font-weight: bold;
        border-bottom: 1px solid #383838;
        padding-bottom: 12px;
    }
    .visualizer {
        width: 100%;
        height: 80px;
        background: #1e1e1e;
        border: 1px solid #383838;
        border-radius: 3px;
        margin-top: 15px;
    }
    textarea {
        width: 100%;
        padding: 5px;
        border: 1px solid #444;
        border-radius: 3px;
        background: #1e1e1e;
        color: #e0e0e0;
        font-size: 0.8em;
        resize: vertical;
    }
    </style>
</head>
<body>
    <div class="container">
        <h1>SOVL System Control Panel</h1>

        <!-- Core Configuration -->
        <div class="section">
            <div class="section-title">Core Configuration</div>
            <div class="control-group">
                <div class="control-item">
                    <label>Base Model</label>
                    <select id="base_model_name">
                        <option value="gpt2">GPT-2</option>
                        <option value="bert">BERT</option>
                        <option value="roberta">RoBERTa</option>
                    </select>
                </div>
                <div class="control-item">
                    <label>Scaffold Model</label>
                    <select id="scaffold_model_name">
                        <option value="gpt2">GPT-2</option>
                        <option value="bert">BERT</option>
                        <option value="roberta">RoBERTa</option>
                    </select>
                </div>
                <div class="control-item">
                    <label>Cross Attn Layers</label>
                    <input type="range" id="cross_attn_layers" min="0" max="11" value="5">
                    <span class="value-display" id="cross_attn_layers_value">5</span>
                </div>
                <div class="control-item">
                    <label>Quantization</label>
                    <select id="quantization">
                        <option value="fp16">FP16</option>
                        <option value="int8">INT8</option>
                        <option value="int4">INT4</option>
                    </select>
                </div>
                <div class="control-item">
                    <label>Layer Mode</label>
                    <select id="layer_selection_mode">
                        <option value="early">Early</option>
                        <option value="late">Late</option>
                        <option value="balanced">Balanced</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div class="control-item" id="custom_layers_container" style="display: none;">
                    <label>Custom Layers</label>
                    <input type="text" id="custom_layers" placeholder="e.g., 4,5,6,7">
                </div>
                <div class="control-item">
                    <label>Valid Split</label>
                    <input type="range" id="valid_split_ratio" min="0.1" max="0.5" step="0.1" value="0.2">
                    <span class="value-display" id="valid_split_ratio_value">0.2</span>
                </div>
                <div class="control-item">
                    <label>Random Seed</label>
                    <input type="range" id="random_seed" min="0" max="100" value="42">
                    <span class="value-display" id="random_seed_value">42</span>
                </div>
            </div>
        </div>

        <!-- LoRA Configuration -->
        <div class="section">
            <div class="section-title">LoRA Configuration</div>
            <div class="control-group">
                <div class="control-item">
                    <label>LoRA Rank</label>
                    <input type="range" id="lora_rank" min="1" max="16" value="8">
                    <span class="value-display" id="lora_rank_value">8</span>
                </div>
                <div class="control-item">
                    <label>LoRA Alpha</label>
                    <input type="range" id="lora_alpha" min="8" max="32" value="16">
                    <span class="value-display" id="lora_alpha_value">16</span>
                </div>
                <div class="control-item">
                    <label>LoRA Dropout</label>
                    <input type="range" id="lora_dropout" min="0" max="0.5" step="0.05" value="0.1">
                    <span class="value-display" id="lora_dropout_value">0.1</span>
                </div>
                <div class="control-item">
                    <label>Target Modules</label>
                    <select id="lora_target_modules" multiple>
                        <option value="c_attn" selected>c_attn</option>
                        <option value="c_proj" selected>c_proj</option>
                        <option value="c_fc" selected>c_fc</option>
                        <option value="q_proj">q_proj</option>
                        <option value="v_proj">v_proj</option>
                    </select>
                </div>
                <div class="control-item">
                    <label>Enable LoRA</label>
                    <input type="checkbox" id="enable_lora_adapters" checked>
                </div>
            </div>
        </div>

        <!-- Training Parameters -->
        <div class="section">
            <div class="section-title">Training Parameters</div>
            <div class="control-group">
                <div class="control-item">
                    <label>Epochs</label>
                    <input type="range" id="train_epochs" min="1" max="10" value="3">
                    <span class="value-display" id="train_epochs_value">3</span>
                </div>
                <div class="control-item">
                    <label>Batch Size</label>
                    <input type="range" id="batch_size" min="1" max="16" value="1">
                    <span class="value-display" id="batch_size_value">1</span>
                </div>
                <div class="control-item">
                    <label>Learning Rate</label>
                    <input type="range" id="learning_rate" min="0.00001" max="0.001" step="0.00001" value="0.0003">
                    <span class="value-display" id="learning_rate_value">0.0003</span>
                </div>
                <div class="control-item">
                    <label>Max Seq Length</label>
                    <input type="range" id="max_seq_length" min="64" max="256" value="128">
                    <span class="value-display" id="max_seq_length_value">128</span>
                </div>
                <div class="control-item">
                    <label>Capacity Factor</label>
                    <input type="range" id="lifecycle_capacity_factor" min="0.001" max="0.1" step="0.001" value="0.01">
                    <span class="value-display" id="lifecycle_capacity_factor_value">0.01</span>
                </div>
                <div class="control-item">
                    <label>Lifecycle Curve</label>
                    <select id="lifecycle_curve">
                        <option value="sigmoid_linear">Sigmoid Linear</option>
                        <option value="exponential">Exponential</option>
                    </select>
                </div>
                <div class="control-item">
                    <label>Accum Steps</label>
                    <input type="range" id="accumulation_steps" min="1" max="8" value="4">
                    <span class="value-display" id="accumulation_steps_value">4</span>
                </div>
                <div class="control-item">
                    <label>Max Patience</label>
                    <input type="range" id="max_patience" min="1" max="5" value="2">
                    <span class="value-display" id="max_patience_value">2</span>
                </div>
                <div class="control-item">
                    <label>Eager Gain</label>
                    <input type="range" id="exposure_gain_eager" min="1" max="5" value="3">
                    <span class="value-display" id="exposure_gain_eager_value">3</span>
                </div>
                <div class="control-item">
                    <label>Default Gain</label>
                    <input type="range" id="exposure_gain_default" min="1" max="5" value="2">
                    <span class="value-display" id="exposure_gain_default_value">2</span>
                </div>
            </div>
        </div>

        <!-- Sleep & Dreaming -->
        <div class="section">
            <div class="section-title">Sleep & Dreaming</div>
            <div class="control-group">
                <div class="control-item">
                    <label>Conf Threshold</label>
                    <input type="range" id="sleep_conf_threshold" min="0.5" max="0.9" step="0.1" value="0.7">
                    <span class="value-display" id="sleep_conf_threshold_value">0.7</span>
                </div>
                <div class="control-item">
                    <label>Time Factor</label>
                    <input type="range" id="sleep_time_factor" min="0.5" max="5" step="0.5" value="1">
                    <span class="value-display" id="sleep_time_factor_value">1</span>
                </div>
                <div class="control-item">
                    <label>Log Min</label>
                    <input type="range" id="sleep_log_min" min="5" max="20" value="10">
                    <span class="value-display" id="sleep_log_min_value">10</span>
                </div>
                <div class="control-item">
                    <label>Swing Var</label>
                    <input type="range" id="dream_swing_var" min="0.05" max="0.2" step="0.05" value="0.1">
                    <span class="value-display" id="dream_swing_var_value">0.1</span>
                </div>
                <div class="control-item">
                    <label>Lifecycle Delta</label>
                    <input type="range" id="dream_lifecycle_delta" min="0.05" max="0.2" step="0.05" value="0.1">
                    <span class="value-display" id="dream_lifecycle_delta_value">0.1</span>
                </div>
                <div class="control-item">
                    <label>Noise Scale</label>
                    <input type="range" id="dream_noise_scale" min="0.01" max="0.1" step="0.01" value="0.05">
                    <span class="value-display" id="dream_noise_scale_value">0.05</span>
                </div>
                <div class="control-item">
                    <label>Memory Weight</label>
                    <input type="range" id="dream_memory_weight" min="0" max="0.5" step="0.1" value="0.1">
                    <span class="value-display" id="dream_memory_weight_value">0.1</span>
                </div>
                <div class="control-item">
                    <label>Memory Maxlen</label>
                    <input type="range" id="dream_memory_maxlen" min="5" max="20" value="10">
                    <span class="value-display" id="dream_memory_maxlen_value">10</span>
                </div>
                <div class="control-item">
                    <label>Prompt Weight</label>
                    <input type="range" id="dream_prompt_weight" min="0" max="1" step="0.1" value="0.5">
                    <span class="value-display" id="dream_prompt_weight_value">0.5</span>
                </div>
                <div class="control-item">
                    <label>Novelty Boost</label>
                    <input type="range" id="dream_novelty_boost" min="0" max="0.05" step="0.01" value="0.03">
                    <span class="value-display" id="dream_novelty_boost_value">0.03</span>
                </div>
                <div class="control-item">
                    <label>Memory Decay</label>
                    <input type="range" id="dream_memory_decay" min="0" max="1" step="0.1" value="0.95">
                    <span class="value-display" id="dream_memory_decay_value">0.95</span>
                </div>
                <div class="control-item">
                    <label>Prune Threshold</label>
                    <input type="range" id="dream_prune_threshold" min="0" max="1" step="0.1" value="0.1">
                    <span class="value-display" id="dream_prune_threshold_value">0.1</span>
                </div>
                <div class="control-item">
                    <label>Enable Dreaming</label>
                    <input type="checkbox" id="enable_dreaming" checked>
                </div>
                <div class="control-item">
                    <label>Dream Temperament</label>
                    <input type="checkbox" id="dream_temperament_on" checked>
                </div>
                <div class="control-item">
                    <label>Prompt-Driven</label>
                    <input type="checkbox" id="enable_prompt_driven_dreams" checked>
                </div>
                <div class="control-item">
                    <label>Enable Gestation</label>
                    <input type="checkbox" id="enable_gestation" checked>
                </div>
                <div class="control-item">
                    <label>Sleep Training</label>
                    <input type="checkbox" id="enable_sleep_training" checked>
                </div>
            </div>
        </div>

        <!-- Temperament Controls -->
        <div class="section">
            <div class="section-title">Temperament Controls</div>
            <div class="control-group">
                <div class="control-item">
                    <label>Eager Threshold</label>
                    <input type="range" id="temp_eager_threshold" min="0.7" max="0.9" step="0.1" value="0.8">
                    <span class="value-display" id="temp_eager_threshold_value">0.8</span>
                </div>
                <div class="control-item">
                    <label>Sluggish Threshold</label>
                    <input type="range" id="temp_sluggish_threshold" min="0.4" max="0.6" step="0.1" value="0.6">
                    <span class="value-display" id="temp_sluggish_threshold_value">0.6</span>
                </div>
                <div class="control-item">
                    <label>Mood Influence</label>
                    <input type="range" id="temp_mood_influence" min="0" max="1" step="0.1" value="0">
                    <span class="value-display" id="temp_mood_influence_value">0</span>
                </div>
                <div class="control-item">
                    <label>Curiosity Boost</label>
                    <input type="range" id="temp_curiosity_boost" min="0" max="0.5" step="0.1" value="0.5">
                    <span class="value-display" id="temp_curiosity_boost_value">0.5</span>
                </div>
                <div class="control-item">
                    <label>Restless Drop</label>
                    <input type="range" id="temp_restless_drop" min="0" max="0.5" step="0.1" value="0.1">
                    <span class="value-display" id="temp_restless_drop_value">0.1</span>
                </div>
                <div class="control-item">
                    <label>Melancholy Noise</label>
                    <input type="range" id="temp_melancholy_noise" min="0" max="0.05" step="0.01" value="0.02">
                    <span class="value-display" id="temp_melancholy_noise_value">0.02</span>
                </div>
                <div class="control-item">
                    <label>Feedback Strength</label>
                    <input type="range" id="conf_feedback_strength" min="0" max="1" step="0.1" value="0.5">
                    <span class="value-display" id="conf_feedback_strength_value">0.5</span>
                </div>
                <div class="control-item">
                    <label>Smoothing Factor</label>
                    <input type="range" id="temp_smoothing_factor" min="0" max="1" step="0.1" value="0">
                    <span class="value-display" id="temp_smoothing_factor_value">0</span>
                </div>
                <div class="control-item">
                    <label>Enable Temperament</label>
                    <input type="checkbox" id="enable_temperament" checked>
                </div>
                <div class="control-item">
                    <label>Confidence Tracking</label>
                    <input type="checkbox" id="enable_confidence_tracking" checked>
                </div>
            </div>
        </div>

        <!-- Runtime Controls -->
        <div class="section">
            <div class="section-title">Runtime Controls</div>
            <div class="control-group">
                <div class="control-item">
                    <label>Scaffold Weight Cap</label>
                    <input type="range" id="scaffold_weight_cap" min="0" max="1" step="0.1" value="0.9">
                    <span class="value-display" id="scaffold_weight_cap_value">0.9</span>
                </div>
                <div class="control-item">
                    <label>Memory Decay</label>
                    <input type="range" id="memory_decay_rate" min="0" max="1" step="0.1" value="0.95">
                    <span class="value-display" id="memory_decay_rate_value">0.95</span>
                </div>
                <div class="control-item">
                    <label>Scaffold Memory</label>
                    <input type="checkbox" id="use_scaffold_memory" checked>
                </div>
                <div class="control-item">
                    <label>Token Map Memory</label>
                    <input type="checkbox" id="use_token_map_memory" checked>
                </div>
                <div class="control-item">
                    <label>Dynamic Cross Attn</label>
                    <input type="checkbox" id="enable_dynamic_cross_attention" checked>
                </div>
                <div class="control-item">
                    <label>Cross Attention</label>
                    <input type="checkbox" id="enable_cross_attention" checked>
                </div>
                <div class="control-item">
                    <label>Repetition Check</label>
                    <input type="checkbox" id="enable_repetition_check" checked>
                </div>
                <div class="control-item">
                    <label>Lifecycle Weighting</label>
                    <input type="checkbox" id="enable_lifecycle_weighting" checked>
                </div>
                <button onclick="toggleScaffold(true)">Load Scaffold</button>
                <button onclick="toggleScaffold(false)">Unload Scaffold</button>
                <button onclick="resetSystem()">Reinitialize</button>
            </div>
        </div>

        <!-- Prompt Input (New Section) -->
        <div class="section">
            <div class="section-title">Prompt Input</div>
            <div class="control-group">
                <div class="control-item" style="grid-column: 1 / -1;">
                    <label>Prompt</label>
                    <textarea id="user_input" rows="4" placeholder="Enter your prompt..."></textarea>
                </div>
            </div>
        </div>

        <!-- Text Generation (Updated Without Prompt) -->
        <div class="section">
            <div class="section-title">Text Generation</div>
            <div class="control-group">
                <div class="control-item">
                    <label>Scaffold Weight</label>
                    <input type="range" id="scaffold_weight" min="0" max="1" step="0.1" value="0.5">
                    <span class="value-display" id="scaffold_weight_value">0.5</span>
                </div>
                <div class="control-item">
                    <label>Max Tokens</label>
                    <input type="range" id="max_tokens" min="10" max="500" value="60">
                    <span class="value-display" id="max_tokens_value">60</span>
                </div>
                <div class="control-item">
                    <label>Temperature</label>
                    <input type="range" id="base_temperature" min="0.1" max="2.0" step="0.1" value="0.7">
                    <span class="value-display" id="base_temperature_value">0.7</span>
                </div>
                <div class="control-item">
                    <label>Save Path</label>
                    <input type="text" id="save_path_prefix" value="state">
                </div>
            </div>
            <div class="control-group">
                <button onclick="generateResponse()">Generate</button>
                <button onclick="startTraining()">Train Model</button>
                <button onclick="exportConfig()">Export Config</button>
            </div>
        </div>

        <!-- Output Section -->
        <div class="section">
            <div class="section-title">Output</div>
            <div class="status-bar" id="status">System Ready</div>
            <div class="response" id="response"></div>
            <canvas class="visualizer" id="visualizer"></canvas>
        </div>
    </div>

    <script>
        // Updated JSON Configuration
        const config = {
            "core_config": {
                "base_model_name": "gpt2",
                "scaffold_model_name": "gpt2",
                "cross_attn_layers": [5, 7],
                "use_dynamic_layers": false,
                "layer_selection_mode": "balanced",
                "custom_layers": null,
                "valid_split_ratio": 0.2,
                "random_seed": 42,
                "quantization": "fp16"
            },
            "lora_config": {
                "lora_rank": 8,
                "lora_alpha": 16,
                "lora_dropout": 0.1,
                "lora_target_modules": ["c_attn", "c_proj", "c_fc"]
            },
            "training_config": {
                "learning_rate": 0.0003,
                "train_epochs": 3,
                "batch_size": 1,
                "max_seq_length": 128,
                "lifecycle_capacity_factor": 0.01,
                "lifecycle_curve": "sigmoid_linear",
                "accumulation_steps": 4,
                "exposure_gain_eager": 3,
                "exposure_gain_default": 2,
                "max_patience": 2
            },
            "controls_config": {
                "sleep_conf_threshold": 0.7,
                "sleep_time_factor": 1.0,
                "sleep_log_min": 10,
                "dream_swing_var": 0.1,
                "dream_lifecycle_delta": 0.1,
                "dream_temperament_on": true,
                "dream_noise_scale": 0.05,
                "temp_eager_threshold": 0.8,
                "temp_sluggish_threshold": 0.6,
                "temp_mood_influence": 0.0,
                "scaffold_weight_cap": 0.9,
                "base_temperature": 0.7,
                "save_path_prefix": "state",
                "dream_memory_weight": 0.1,
                "dream_memory_maxlen": 10,
                "dream_prompt_weight": 0.5,
                "dream_novelty_boost": 0.03,
                "temp_curiosity_boost": 0.5,
                "temp_restless_drop": 0.1,
                "temp_melancholy_noise": 0.02,
                "conf_feedback_strength": 0.5,
                "temp_smoothing_factor": 0.0,
                "dream_memory_decay": 0.95,
                "dream_prune_threshold": 0.1,
                "use_scaffold_memory": true,
                "use_token_map_memory": true,
                "memory_decay_rate": 0.95,
                "has_woken": false,
                "is_sleeping": false,
                "confidence_history_maxlen": 5,
                "temperament_history_maxlen": 5,
                "enable_dreaming": true,
                "enable_temperament": true,
                "enable_confidence_tracking": true,
                "enable_gestation": true,
                "enable_sleep_training": true,
                "enable_cross_attention": true,
                "enable_dynamic_cross_attention": true,
                "enable_lora_adapters": true,
                "enable_repetition_check": true,
                "enable_prompt_driven_dreams": true,
                "enable_lifecycle_weighting": true
            }
        };

        // Dynamic UI Interactions
        document.getElementById('layer_selection_mode').addEventListener('change', (e) => {
            document.getElementById('custom_layers_container').style.display = 
                e.target.value === 'custom' ? 'block' : 'none';
        });

        // Update Slider Value Displays
        function updateSliderValue(sliderId) {
            const slider = document.getElementById(sliderId);
            const valueDisplay = document.getElementById(`${sliderId}_value`);
            valueDisplay.textContent = slider.value;
        }

        document.querySelectorAll('input[type="range"]').forEach(slider => {
            slider.addEventListener('input', () => updateSliderValue(slider.id));
            updateSliderValue(slider.id);
        });

        // Initialize UI from Config
        function initUIFromConfig() {
            document.getElementById('base_model_name').value = config.core_config.base_model_name;
            document.getElementById('scaffold_model_name').value = config.core_config.scaffold_model_name;
            document.getElementById('cross_attn_layers').value = config.core_config.cross_attn_layers[0];
            document.getElementById('quantization').value = config.core_config.quantization;
            document.getElementById('layer_selection_mode').value = config.core_config.layer_selection_mode;
            document.getElementById('custom_layers').value = config.core_config.custom_layers || '';
            document.getElementById('valid_split_ratio').value = config.core_config.valid_split_ratio;
            document.getElementById('random_seed').value = config.core_config.random_seed;

            document.getElementById('lora_rank').value = config.lora_config.lora_rank;
            document.getElementById('lora_alpha').value = config.lora_config.lora_alpha;
            document.getElementById('lora_dropout').value = config.lora_config.lora_dropout;
            Array.from(document.getElementById('lora_target_modules').options).forEach(opt => {
                opt.selected = config.lora_config.lora_target_modules.includes(opt.value);
            });
            document.getElementById('enable_lora_adapters').checked = config.controls_config.enable_lora_adapters;

            document.getElementById('train_epochs').value = config.training_config.train_epochs;
            document.getElementById('batch_size').value = config.training_config.batch_size;
            document.getElementById('learning_rate').value = config.training_config.learning_rate;
            document.getElementById('max_seq_length').value = config.training_config.max_seq_length;
            document.getElementById('lifecycle_capacity_factor').value = config.training_config.lifecycle_capacity_factor;
            document.getElementById('lifecycle_curve').value = config.training_config.lifecycle_curve;
            document.getElementById('accumulation_steps').value = config.training_config.accumulation_steps;
            document.getElementById('max_patience').value = config.training_config.max_patience;
            document.getElementById('exposure_gain_eager').value = config.training_config.exposure_gain_eager;
            document.getElementById('exposure_gain_default').value = config.training_config.exposure_gain_default;

            document.getElementById('sleep_conf_threshold').value = config.controls_config.sleep_conf_threshold;
            document.getElementById('sleep_time_factor').value = config.controls_config.sleep_time_factor;
            document.getElementById('sleep_log_min').value = config.controls_config.sleep_log_min;
            document.getElementById('dream_swing_var').value = config.controls_config.dream_swing_var;
            document.getElementById('dream_lifecycle_delta').value = config.controls_config.dream_lifecycle_delta;
            document.getElementById('dream_temperament_on').checked = config.controls_config.dream_temperament_on;
            document.getElementById('dream_noise_scale').value = config.controls_config.dream_noise_scale;
            document.getElementById('dream_memory_weight').value = config.controls_config.dream_memory_weight;
            document.getElementById('dream_memory_maxlen').value = config.controls_config.dream_memory_maxlen;
            document.getElementById('dream_prompt_weight').value = config.controls_config.dream_prompt_weight;
            document.getElementById('dream_novelty_boost').value = config.controls_config.dream_novelty_boost;
            document.getElementById('dream_memory_decay').value = config.controls_config.dream_memory_decay;
            document.getElementById('dream_prune_threshold').value = config.controls_config.dream_prune_threshold;
            document.getElementById('enable_dreaming').checked = config.controls_config.enable_dreaming;
            document.getElementById('enable_prompt_driven_dreams').checked = config.controls_config.enable_prompt_driven_dreams;
            document.getElementById('enable_gestation').checked = config.controls_config.enable_gestation;
            document.getElementById('enable_sleep_training').checked = config.controls_config.enable_sleep_training;

            document.getElementById('temp_eager_threshold').value = config.controls_config.temp_eager_threshold;
            document.getElementById('temp_sluggish_threshold').value = config.controls_config.temp_sluggish_threshold;
            document.getElementById('temp_mood_influence').value = config.controls_config.temp_mood_influence;
            document.getElementById('temp_curiosity_boost').value = config.controls_config.temp_curiosity_boost;
            document.getElementById('temp_restless_drop').value = config.controls_config.temp_restless_drop;
            document.getElementById('temp_melancholy_noise').value = config.controls_config.temp_melancholy_noise;
            document.getElementById('conf_feedback_strength').value = config.controls_config.conf_feedback_strength;
            document.getElementById('temp_smoothing_factor').value = config.controls_config.temp_smoothing_factor;
            document.getElementById('enable_temperament').checked = config.controls_config.enable_temperament;
            document.getElementById('enable_confidence_tracking').checked = config.controls_config.enable_confidence_tracking;

            document.getElementById('scaffold_weight_cap').value = config.controls_config.scaffold_weight_cap;
            document.getElementById('memory_decay_rate').value = config.controls_config.memory_decay_rate;
            document.getElementById('use_scaffold_memory').checked = config.controls_config.use_scaffold_memory;
            document.getElementById('use_token_map_memory').checked = config.controls_config.use_token_map_memory;
            document.getElementById('enable_dynamic_cross_attention').checked = config.controls_config.enable_dynamic_cross_attention;
            document.getElementById('enable_cross_attention').checked = config.controls_config.enable_cross_attention;
            document.getElementById('enable_repetition_check').checked = config.controls_config.enable_repetition_check;
            document.getElementById('enable_lifecycle_weighting').checked = config.controls_config.enable_lifecycle_weighting;

            document.getElementById('scaffold_weight').value = config.controls_config.scaffold_weight_cap * 0.5;
            document.getElementById('base_temperature').value = config.controls_config.base_temperature;
            document.getElementById('save_path_prefix').value = config.controls_config.save_path_prefix;
            document.getElementById('max_tokens').value = 60;

            document.querySelectorAll('input[type="range"]').forEach(slider => updateSliderValue(slider.id));
        }

        // Update Config from UI
        function updateConfigFromUI() {
            config.core_config.base_model_name = document.getElementById('base_model_name').value;
            config.core_config.scaffold_model_name = document.getElementById('scaffold_model_name').value;
            config.core_config.cross_attn_layers = [parseInt(document.getElementById('cross_attn_layers').value)];
            config.core_config.quantization = document.getElementById('quantization').value;
            config.core_config.layer_selection_mode = document.getElementById('layer_selection_mode').value;
            config.core_config.custom_layers = document.getElementById('custom_layers').value || null;
            config.core_config.valid_split_ratio = parseFloat(document.getElementById('valid_split_ratio').value);
            config.core_config.random_seed = parseInt(document.getElementById('random_seed').value);
            config.core_config.use_dynamic_layers = document.getElementById('layer_selection_mode').value === 'dynamic';

            config.lora_config.lora_rank = parseInt(document.getElementById('lora_rank').value);
            config.lora_config.lora_alpha = parseInt(document.getElementById('lora_alpha').value);
            config.lora_config.lora_dropout = parseFloat(document.getElementById('lora_dropout').value);
            config.lora_config.lora_target_modules = Array.from(document.getElementById('lora_target_modules').selectedOptions).map(opt => opt.value);
            config.controls_config.enable_lora_adapters = document.getElementById('enable_lora_adapters').checked;

            config.training_config.train_epochs = parseInt(document.getElementById('train_epochs').value);
            config.training_config.batch_size = parseInt(document.getElementById('batch_size').value);
            config.training_config.learning_rate = parseFloat(document.getElementById('learning_rate').value);
            config.training_config.max_seq_length = parseInt(document.getElementById('max_seq_length').value);
            config.training_config.lifecycle_capacity_factor = parseFloat(document.getElementById('lifecycle_capacity_factor').value);
            config.training_config.lifecycle_curve = document.getElementById('lifecycle_curve').value;
            config.training_config.accumulation_steps = parseInt(document.getElementById('accumulation_steps').value);
            config.training_config.max_patience = parseInt(document.getElementById('max_patience').value);
            config.training_config.exposure_gain_eager = parseInt(document.getElementById('exposure_gain_eager').value);
            config.training_config.exposure_gain_default = parseInt(document.getElementById('exposure_gain_default').value);

            config.controls_config.sleep_conf_threshold = parseFloat(document.getElementById('sleep_conf_threshold').value);
            config.controls_config.sleep_time_factor = parseFloat(document.getElementById('sleep_time_factor').value);
            config.controls_config.sleep_log_min = parseInt(document.getElementById('sleep_log_min').value);
            config.controls_config.dream_swing_var = parseFloat(document.getElementById('dream_swing_var').value);
            config.controls_config.dream_lifecycle_delta = parseFloat(document.getElementById('dream_lifecycle_delta').value);
            config.controls_config.dream_temperament_on = document.getElementById('dream_temperament_on').checked;
            config.controls_config.dream_noise_scale = parseFloat(document.getElementById('dream_noise_scale').value);
            config.controls_config.dream_memory_weight = parseFloat(document.getElementById('dream_memory_weight').value);
            config.controls_config.dream_memory_maxlen = parseInt(document.getElementById('dream_memory_maxlen').value);
            config.controls_config.dream_prompt_weight = parseFloat(document.getElementById('dream_prompt_weight').value);
            config.controls_config.dream_novelty_boost = parseFloat(document.getElementById('dream_novelty_boost').value);
            config.controls_config.dream_memory_decay = parseFloat(document.getElementById('dream_memory_decay').value);
            config.controls_config.dream_prune_threshold = parseFloat(document.getElementById('dream_prune_threshold').value);
            config.controls_config.enable_dreaming = document.getElementById('enable_dreaming').checked;
            config.controls_config.enable_prompt_driven_dreams = document.getElementById('enable_prompt_driven_dreams').checked;
            config.controls_config.enable_gestation = document.getElementById('enable_gestation').checked;
            config.controls_config.enable_sleep_training = document.getElementById('enable_sleep_training').checked;

            config.controls_config.temp_eager_threshold = parseFloat(document.getElementById('temp_eager_threshold').value);
            config.controls_config.temp_sluggish_threshold = parseFloat(document.getElementById('temp_sluggish_threshold').value);
            config.controls_config.temp_mood_influence = parseFloat(document.getElementById('temp_mood_influence').value);
            config.controls_config.temp_curiosity_boost = parseFloat(document.getElementById('temp_curiosity_boost').value);
            config.controls_config.temp_restless_drop = parseFloat(document.getElementById('temp_restless_drop').value);
            config.controls_config.temp_melancholy_noise = parseFloat(document.getElementById('temp_melancholy_noise').value);
            config.controls_config.conf_feedback_strength = parseFloat(document.getElementById('conf_feedback_strength').value);
            config.controls_config.temp_smoothing_factor = parseFloat(document.getElementById('temp_smoothing_factor').value);
            config.controls_config.enable_temperament = document.getElementById('enable_temperament').checked;
            config.controls_config.enable_confidence_tracking = document.getElementById('enable_confidence_tracking').checked;

            config.controls_config.scaffold_weight_cap = parseFloat(document.getElementById('scaffold_weight_cap').value);
            config.controls_config.memory_decay_rate = parseFloat(document.getElementById('memory_decay_rate').value);
            config.controls_config.use_scaffold_memory = document.getElementById('use_scaffold_memory').checked;
            config.controls_config.use_token_map_memory = document.getElementById('use_token_map_memory').checked;
            config.controls_config.enable_dynamic_cross_attention = document.getElementById('enable_dynamic_cross_attention').checked;
            config.controls_config.enable_cross_attention = document.getElementById('enable_cross_attention').checked;
            config.controls_config.enable_repetition_check = document.getElementById('enable_repetition_check').checked;
            config.controls_config.enable_lifecycle_weighting = document.getElementById('enable_lifecycle_weighting').checked;

            config.controls_config.base_temperature = parseFloat(document.getElementById('base_temperature').value);
            config.controls_config.save_path_prefix = document.getElementById('save_path_prefix').value;
        }

        // Control Handlers
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        function toggleScaffold(enable) {
            updateStatus(`Scaffold ${enable ? 'loaded' : 'unloaded'}`);
            updateConfigFromUI();
        }

        function resetSystem() {
            const quantization = document.getElementById('quantization').value;
            updateStatus(`Reinitializing system with ${quantization} quantization...`);
            updateConfigFromUI();
        }

        function generateResponse() {
            const params = collectGenerationParams();
            updateStatus(`Generating response with weight=${params.scaffold_weight}...`);
            document.getElementById('response').textContent = 
                `Generated response for: ${params.prompt}\n` +
                `(Weight: ${params.scaffold_weight}, Temp: ${params.temperature})`;
            updateVisualizer();
            updateConfigFromUI();
        }

        function startTraining() {
            const params = collectTrainingParams();
            updateStatus(`Starting training for ${params.epochs} epochs...`);
            updateVisualizer();
            updateConfigFromUI();
        }

        function exportConfig() {
            updateConfigFromUI();
            const jsonStr = JSON.stringify(config, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sovl_config.json';
            a.click();
            URL.revokeObjectURL(url);
            updateStatus('Config exported as sovl_config.json');
        }

        function collectTrainingParams() {
            return {
                epochs: parseInt(document.getElementById('train_epochs').value),
                batch_size: parseInt(document.getElementById('batch_size').value),
                learning_rate: parseFloat(document.getElementById('learning_rate').value),
                max_seq_length: parseInt(document.getElementById('max_seq_length').value)
            };
        }

        function collectGenerationParams() {
            return {
                prompt: document.getElementById('user_input').value,
                scaffold_weight: parseFloat(document.getElementById('scaffold_weight').value),
                max_tokens: parseInt(document.getElementById('max_tokens').value),
                temperature: parseFloat(document.getElementById('base_temperature').value)
            };
        }

        // Visualizer Logic
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;

        function updateVisualizer() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#00ff99';
            ctx.lineWidth = 2;
            ctx.beginPath();
            const temp = parseFloat(document.getElementById('base_temperature').value);
            const weight = parseFloat(document.getElementById('scaffold_weight').value);
            for (let x = 0; x < canvas.width; x++) {
                const y = canvas.height / 2 + Math.sin(x * 0.05 + temp) * 30 * weight;
                x === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            }
            ctx.stroke();
            requestAnimationFrame(updateVisualizer);
        }

        // Initialize
        initUIFromConfig();
        updateVisualizer();
    </script>
</body>
</html>
