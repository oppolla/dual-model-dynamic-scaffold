<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMDF Synth Control Panel</title>
    <!-- Existing styles remain unchanged -->
    <style>
        /* Previous CSS here */
    </style>
</head>
<body>
    <div class="container">
        <h1>DMDF Synth Control Panel</h1>
        <!-- Existing sections remain unchanged -->
        <!-- Add a button to export config -->
        <div class="section">
            <div class="section-title">Config Management</div>
            <div class="control-group">
                <button onclick="exportConfig()">Export Config</button>
            </div>
        </div>
    </div>

    <script>
        // JSON Configuration
        const config = {
            "core_config": {
                "base_model_name": "gpt2",
                "scaffold_model_name": "gpt2",
                "cross_attn_layers": [5, 7],
                "use_dynamic_layers": false,
                "layer_selection_mode": "balanced",
                "custom_layers": null,
                "valid_split_ratio": 0.2,
                "random_seed": 42,
                "quantization": "fp16"
            },
            "lora_config": {
                "lora_rank": 8,
                "lora_alpha": 16,
                "lora_dropout": 0.1,
                "lora_target_modules": ["c_attn", "c_proj", "c_fc"]
            },
            "training_config": {
                "learning_rate": 0.0003,
                "train_epochs": 3,
                "batch_size": 1,
                "max_seq_length": 128,
                "sigmoid_scale": 0.5,
                "sigmoid_shift": 5.0,
                "lifecycle_capacity_factor": 0.01,
                "lifecycle_curve": "sigmoid_linear"
            },
            "controls_config": {
                "sleep_conf_threshold": 0.7,
                "sleep_time_factor": 1.0,
                "sleep_log_min": 10,
                "dream_swing_var": 0.1,
                "dream_lifecycle_delta": 0.1,
                "dream_temperament_on": true,
                "dream_noise_scale": 0.05,
                "temp_eager_threshold": 0.8,
                "temp_sluggish_threshold": 0.6,
                "temp_mood_influence": 0.0,
                "scaffold_weight_cap": 0.9,
                "base_temperature": 0.7,
                "save_path_prefix": "state",
                "dream_memory_weight": 0.1,
                "dream_memory_maxlen": 10,
                "dream_prompt_weight": 0.5,
                "dream_novelty_boost": 0.03,
                "temp_curiosity_boost": 0.5,
                "temp_restless_drop": 0.1,
                "temp_melancholy_noise": 0.02,
                "conf_feedback_strength": 0.5,
                "temp_smoothing_factor": 0.0,
                "dream_memory_decay": 0.95,
                "dream_prune_threshold": 0.1,
                "lora_capacity": null,
                "max_patience": 2,
                "accumulation_steps": 4
            }
        };

        // Initialize UI with JSON values
        function initUIFromConfig() {
            // Core Config
            document.getElementById('quantization').value = config.core_config.quantization;
            document.getElementById('layer_mode').value = config.core_config.use_dynamic_layers ? 'dynamic' : 'fixed';
            document.getElementById('custom_layers').value = config.core_config.custom_layers || '';
            document.getElementById('jit_mode').value = 'on'; // Assuming JIT is enabled by default

            // Training Config
            document.getElementById('epochs').value = config.training_config.train_epochs;
            document.getElementById('batch_size').value = config.training_config.batch_size;
            document.getElementById('lr').value = config.training_config.learning_rate;
            document.getElementById('max_seq').value = config.training_config.max_seq_length;

            // Controls Config
            document.getElementById('scaffold_weight').value = config.controls_config.scaffold_weight_cap * 0.5; // Default to half of cap
            document.getElementById('temperature').value = config.controls_config.base_temperature;
            document.getElementById('max_tokens').value = 60; // Not in JSON, using UI default
        }

        // Update Config from UI
        function updateConfigFromUI() {
            config.core_config.quantization = document.getElementById('quantization').value;
            config.core_config.use_dynamic_layers = document.getElementById('layer_mode').value === 'dynamic';
            config.core_config.custom_layers = document.getElementById('custom_layers').value || null;

            config.training_config.train_epochs = parseInt(document.getElementById('epochs').value);
            config.training_config.batch_size = parseInt(document.getElementById('batch_size').value);
            config.training_config.learning_rate = parseFloat(document.getElementById('lr').value);
            config.training_config.max_seq_length = parseInt(document.getElementById('max_seq').value);

            config.controls_config.scaffold_weight_cap = Math.min(0.9, parseFloat(document.getElementById('scaffold_weight').value));
            config.controls_config.base_temperature = parseFloat(document.getElementById('temperature').value);
        }

        // Existing Functions with Config Updates
        function toggleScaffold(enable) {
            updateStatus(`Scaffold ${enable ? 'loaded' : 'unloaded'}`);
            updateConfigFromUI();
        }

        function toggleDynamicLayers() {
            const current = document.getElementById('layer_mode').value;
            document.getElementById('layer_mode').value = current === 'dynamic' ? 'fixed' : 'dynamic';
            updateStatus(`Dynamic layers ${current === 'dynamic' ? 'disabled' : 'enabled'}`);
            updateConfigFromUI();
        }

        function resetSystem() {
            const quantization = document.getElementById('quantization').value;
            updateStatus(`Reinitializing system with ${quantization} quantization...`);
            updateConfigFromUI();
        }

        function generateResponse() {
            const params = collectGenerationParams();
            updateStatus(`Generating response with weight=${params.scaffold_weight}...`);
            document.getElementById('response').textContent = 
                `Generated response for: ${params.prompt}\n` +
                `(Weight: ${params.scaffold_weight}, Temp: ${params.temperature})`;
            updateVisualizer();
            updateConfigFromUI();
        }

        function startTraining() {
            const params = collectTrainingParams();
            updateStatus(`Starting training for ${params.epochs} epochs...`);
            updateVisualizer();
            updateConfigFromUI();
        }

        // Export Config
        function exportConfig() {
            updateConfigFromUI();
            const jsonStr = JSON.stringify(config, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dmdf_config.json';
            a.click();
            URL.revokeObjectURL(url);
            updateStatus('Config exported as dmdf_config.json');
        }

        // Existing Functions (unchanged)
        document.getElementById('layer_mode').addEventListener('change', (e) => {
            document.getElementById('custom_layers_container').style.display = 
                e.target.value === 'custom' ? 'block' : 'none';
        });

        function collectTrainingParams() {
            return {
                epochs: parseInt(document.getElementById('epochs').value),
                batch_size: parseInt(document.getElementById('batch_size').value),
                lr: parseFloat(document.getElementById('lr').value),
                max_seq: parseInt(document.getElementById('max_seq').value)
            };
        }

        function collectGenerationParams() {
            return {
                prompt: document.getElementById('user_input').value,
                scaffold_weight: parseFloat(document.getElementById('scaffold_weight').value),
                max_tokens: parseInt(document.getElementById('max_tokens').value),
                temperature: parseFloat(document.getElementById('temperature').value)
            };
        }

        // Visualizer Logic (unchanged)
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;

        function updateVisualizer() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#00ff99';
            ctx.lineWidth = 2;
            ctx.beginPath();
            const temp = parseFloat(document.getElementById('temperature').value);
            const weight = parseFloat(document.getElementById('scaffold_weight').value);
            for (let x = 0; x < canvas.width; x++) {
                const y = canvas.height / 2 + Math.sin(x * 0.05 + temp) * 30 * weight;
                x === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            }
            ctx.stroke();
            requestAnimationFrame(updateVisualizer);
        }

        // Initialize
        initUIFromConfig();
        updateVisualizer();
    </script>
</body>
</html>
